<!--
Author: Callum Taylor
Filename: index.html
License: MIT Open Source License
-->

<!DOCTYPE html>
<html lang="en">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <head>
    <!-- import d3.js version 7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>

    <!-- import tailwind and other stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="./css/index.css" rel="stylesheet" type="text/css" />
    <!-- import font awesome-->
    <script
      src="https://kit.fontawesome.com/339b6d0017.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <!-- document body -->

  <body>
    <div class="wrapper h-screen bg-gray-900">
      <!-- navbar-->
      <nav class="bg-gray-800">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
          <div class="relative flex items-center justify-between h-20">
            <div
              class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start"
            >
              <div class="flex-shrink-0 flex items-center">
                <img
                  class="block h-20 w-auto"
                  src="./assets/logo.PNG"
                  alt="Taylor Analytics"
                />
              </div>
            </div>
            <div
              class="absolute inset-y-0 right-0 flex items-center pr-2 sm:static sm:inset-auto sm:ml-6 sm:pr-0"
            >
              <!-- navbar links -->
              <div class="ml-3 relative">
                <div class="hidden sm:block sm:ml-6">
                  <div class="flex space-x-4">
                    <a
                      href="#"
                      class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium"
                      aria-current="page"
                      >Dashboard</a
                    >

                    <a
                      href="#"
                      class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium"
                      >Github</a
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div class="row content p-3 w-4xl inline-flex">
        <div class="cases-linechart bg-gray-800 mr-3">
          <row class="cases-lc-row inline-flex">
            <h2 class="text-white font-bold p-3">Cases by Country</h2>
          </row>
        </div>
        <!--
        <div class="deaths-linechart bg-gray-800 w-1/2">
          <row class="deaths-lc-row inline-flex">
            <h2 class="text-white font-bold p-3">Deaths by Country</h2>
          </row>
        </div>
      --></div>
    </div>
  </body>

  <!-- internal JS code -->
  <script>
    var cases = [];
    var deaths = [];

    // read covid data as csv file
    const csv = d3.csv(
      "https://raw.githubusercontent.com/taybluetooth/f21dv-lab-3/main/data/owid-covid-data.csv"
    );

    /*
  /////////////////////////
  LINE CHART
  /////////////////////////
  */

    // declare constant values
    const WIDTH = 600;
    const HEIGHT = 400;
    const MARGIN = {
      top: 20,
      right: 30,
      bottom: 30,
      left: 40,
    };
    const INNER_WIDTH = WIDTH - MARGIN.left - MARGIN.right;
    const INNER_HEIGHT = HEIGHT - MARGIN.top - MARGIN.bottom;

    // set the ranges
    var x = d3.scaleTime().range([0, WIDTH]);
    var y = d3.scaleLinear().range([HEIGHT, 0]);

    // append the svg obgect to the body of the page
    // appends a 'group' element to 'svg'
    // moves the 'group' element to the top left margin

    function createSvg(append) {
      var svg = d3
        .select(append)
        .append("svg")
        .attr("width", WIDTH + MARGIN.left + MARGIN.right)
        .attr("height", HEIGHT + MARGIN.top + MARGIN.bottom)
        .append("g")
        .attr("transform", "translate(" + MARGIN.left + "," + MARGIN.top + ")");

      return svg;
    }

    var svg = createSvg(".cases-linechart");

    function initialiseLC(country, arr, svg, data) {
      csv.then((value) => {
        // load csv values into a preprocessing array
        for (var i = 0; i < value.length; i++) {
          if (value[i].location === country) {
            arr.push(value[i]);
          }
        }
        // format the data
        arr.forEach(function (d) {
          d.date = new Date(d.date);
          d.new_cases = +d.new_cases;
          d.new_deaths = +d.new_deaths;
        });

        arr.sort(function (a, b) {
          // turn strings into dates
          return new Date(b.date) - new Date(a.date);
        });

        // cale the range of the data
        x.domain(
          d3.extent(arr, function (d) {
            return d.date;
          })
        ).range([0, WIDTH]);
        y.domain([
          0,
          d3.max(arr, function (d) {
            return data === "cases" ? d.new_cases : d.new_deaths;
          }),
        ]).range([HEIGHT - MARGIN.bottom, MARGIN.top]);

        // define the value line
        var valueLine = d3
          .line()
          .x(function (d) {
            return x(d.date);
          })
          .y(function (d) {
            return y(data === "cases" ? d.new_cases : d.new_deaths);
          });

        // add the case line path.
        svg
          .append("path")
          .data([arr])
          .attr("class", "line")
          .attr("d", valueLine)
          .attr("class", data == "cases" ? "lineBlue" : "linePink");
        // add the x axis
        svg
          .append("g")
          .attr("transform", `translate(0,${HEIGHT - MARGIN.bottom})`)
          .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %y")).ticks(12))
          .attr("id", "xAxis")
          .attr("class", "axisWhite")
          .call((g) => g.selectAll(".tick text"));

        // add the y axis
        svg
          .append("g")
          .call(d3.axisRight(y).tickSize(WIDTH))
          .attr("id", "yAxis")
          .call((g) => g.select(".domain").remove())
          .call((g) =>
            g
              .selectAll(".tick:not(:first-of-type) line")
              .attr("stroke-opacity", 0.5)
              .attr("stroke-dasharray", "2,2")
          )
          .call((g) =>
            g.selectAll(".tick text").attr("x", 4).attr("color", "white")
          );
      });
    }

    // A function that updates the chart when dropdown option is selected
    function updateLC(selectedGroup, arr, svg, data) {
      csv.then((value) => {
        arr = [];

        for (var i = 0; i < value.length; i++) {
          if (value[i].location === selectedGroup) {
            arr.push(value[i]);
          }
        }

        // TODO: Refactor
        // format the data
        arr.forEach(function (d) {
          d.date = new Date(d.date);
          d.new_cases = +d.new_cases;
          d.new_deaths = +d.new_deaths;
        });

        arr.sort(function (a, b) {
          // turn strings into dates
          return new Date(b.date) - new Date(a.date);
        });

        // calc the range of the data
        x.domain(
          d3.extent(arr, function (d) {
            return d.date;
          })
        ).range([0, WIDTH]);
        y.domain([
          0,
          d3.max(arr, function (d) {
            return data === "cases" ? d.new_cases : d.new_deaths;
          }),
        ]).range([HEIGHT - MARGIN.bottom, MARGIN.top]);

        svg
          .selectAll("#xAxis")
          .transition()
          .duration(1000)
          .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %y")).ticks())
          .attr("class", "axisWhite")
          .call((g) => g.selectAll(".tick text"));

        svg
          .selectAll("#yAxis")
          .transition()
          .duration(1000)
          .call(d3.axisRight(y).tickSize(WIDTH))
          .call((g) => g.select(".domain").remove())
          .call((g) =>
            g
              .selectAll(".tick:not(:first-of-type) line")
              .attr("stroke-opacity", 0.5)
              .attr("stroke-dasharray", "2,2")
          )
          .call((g) =>
            g.selectAll(".tick text").attr("x", 4).attr("color", "white")
          );

        // Give these new data to update line
        svg
          .select("path")
          .data([arr])
          .transition()
          .duration(1000)
          .attr(
            "d",
            d3
              .line()
              .x(function (d) {
                return x(d.date);
              })
              .y(function (d) {
                return y(data === "cases" ? d.new_cases : d.new_deaths);
              })
          )
          .attr("stroke", "blue");
      });
    }

    // method which updates the countries line chart
    function countryChange() {
      var country = d3.select(this).property("value");
      updateLC(country, cases, svg, "cases");
      d3.selectAll(`path`).classed("selected", false);
      d3.select(`[name=${country.replace(/\s/g, "")}]`).classed(
        "selected",
        true
      );
    }

    // create the interactivity drop down
    function createDropdown(append, callback) {
      csv.then((value) => {
        var temp = [];
        // load csv values into a preprocessing array
        for (var i = 0; i < value.length; i++) {
          temp.indexOf(value[i].location) === -1
            ? temp.push(value[i].location)
            : [];
        }

        // create dropdown menu of countries
        var dropDown = d3
          .select(append)
          .append("select")
          .attr("name", "country-list")
          .attr("class", "outline-0 bg-gray-800 text-white")
          .on("change", callback);
        var options = dropDown
          .selectAll("option")
          .data(temp)
          .enter()
          .append("option");
        options
          .text(function (d) {
            return d;
          })
          .attr("value", function (d) {
            return d;
          });
      });
    }

    // create dropdown menu
    createDropdown(".cases-lc-row", countryChange);
    // createDropdown(".deaths-lc-row", deathsChange);
    // initialise line chart
    initialiseLC("Afghanistan", cases, svg, "cases");
    // initialiseLC("Afghanistan", deaths, svg2, "deaths");

    /*
  /////////////////////////
  END OF LINE CHART
  /////////////////////////
  */

    // callback function when selecting country
    function selectCountry() {
      d3.select(".selected").classed("selected", false);
      d3.select(this).classed("selected", true);
      console.log(this);
      var country = d3.select(this).attr("class").replace(" selected", "");
      updateLC(country, cases, svg, "cases");
      d3.select("select").property("value", country);
    }

    // declare map constants
    const mapWidth = 800;
    const mapHeight = 498;

    const map = d3
      .select(".content")
      .append("svg")
      .attr("class", "bg-gray-800")
      .attr("width", mapWidth)
      .attr("height", mapHeight); //track where user clicked down

    const projection = d3
      .geoMercator()
      .scale(100)
      .translate([mapWidth / 2, mapHeight / 1.4]);
    const path = d3.geoPath(projection);

    const mapG = map.append("g");

    function createMap() {
      d3.json(
        "https://raw.githubusercontent.com/taybluetooth/f21dv-lab-3/main/data/countries.json"
      ).then((data) => {
        const countries = topojson.feature(data, data.objects.countries);
        mapG
          .selectAll("path")
          .data(countries.features)
          .enter()
          .append("path")
          .attr("class", function (d) {
            return d.properties.name == "Afghanistan"
              ? `selected ${d.properties.name}`
              : d.properties.name;
          })
          .on("click", selectCountry)
          .attr("name", function (d) {
            return d.properties.name.replace(/\s/g, "");
          })
          .attr("id", function (d) {
            return "country" + d.id;
          })
          .style("fill", function (d) {
            return d3
              .schemeBlues[6][Math.floor(Math.random() * (5 - 1 + 1) + 1)];
          })
          .style("stroke", "black")
          .style("stroke-width", "0.1")
          .attr("d", path);
      });

      d3.json("https://raw.githubusercontent.com/taybluetooth/f21dv-lab-3/main/data/lat-long.json").then((data) => {
        mapG
        .selectAll(".mark")
        .data(data.ref_country_codes)
        .enter()
        .append("circle")
        .attr("cx", function (d) {
          return projection([d.longitude, d.latitude])[0];
        })
        .attr("cy", function (d) {
          return projection([d.longitude, d.latitude])[1];
        })
        .attr("r", 2)
        .style("fill", "69b3a2")
        .attr("stroke", "#69b3a2")
        .attr("stroke-width", 0.1)
        .attr("fill-opacity", 0.4);
      })
    }

    // handle zoom and panning
    var zoom = d3
      .zoom()
      .scaleExtent([1, 10])
      .on("zoom", function (event) {
        mapG.selectAll("path").attr("transform", event.transform);
        mapG.selectAll("circle").attr("transform", event.transform);
      });

    map.call(zoom);

    createMap();
  </script>
</html>
